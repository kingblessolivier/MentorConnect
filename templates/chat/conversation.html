{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}Chat with {{ other_user.get_full_name }} - {{ SITE_NAME }}{% endblock %}

{% block dashboard_content %}
<div class="chat-page-layout">
    <!-- Conversations Sidebar -->
    <div class="chat-conversations-sidebar">
        <div class="sidebar-header-chat">
            <h3>Messages</h3>
            <a href="{% url 'chat:list' %}" class="btn btn-ghost btn-sm" title="New Message">
                <i data-feather="edit"></i>
            </a>
        </div>
        <div class="conversation-list-mini">
            {% for conv in conversations %}
            <a href="{% url 'chat:conversation' conv.id %}" class="conv-mini-item {% if conv.id == conversation.id %}active{% endif %}">
                <img src="{{ conv.other_participant.get_avatar_url }}" alt="" class="avatar avatar-sm">
                <div class="conv-mini-info">
                    <span class="conv-mini-name">{{ conv.other_participant.get_full_name }}</span>
                    {% with last=conv.get_last_message %}
                    {% if last %}
                    <span class="conv-mini-preview">{{ last.content|truncatewords:4 }}</span>
                    {% endif %}
                    {% endwith %}
                </div>
                {% if conv.unread_count %}
                <span class="unread-dot"></span>
                {% endif %}
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main-area">
        <!-- Chat Header -->
        <div class="chat-header-main">
            <a href="{% url 'chat:list' %}" class="btn btn-ghost btn-icon mobile-back">
                <i data-feather="arrow-left"></i>
            </a>
            <img src="{{ other_user.get_avatar_url }}" alt="" class="avatar avatar-md">
            <div class="chat-header-info">
                <h3 class="chat-header-name">{{ other_user.get_full_name }}</h3>
                <span class="chat-header-role">{{ other_user.get_role_display }}</span>
            </div>
            <div class="chat-header-actions">
                <a href="{% url 'profiles:detail' other_user.id %}" class="btn btn-ghost btn-icon" title="View Profile">
                    <i data-feather="user"></i>
                </a>
                <button class="btn btn-ghost btn-icon" onclick="toggleChatMenu()" title="More Options">
                    <i data-feather="more-vertical"></i>
                </button>
                <div class="chat-dropdown-menu" id="chatDropdownMenu">
                    <a href="{% url 'profiles:detail' other_user.id %}"><i data-feather="user"></i> View Profile</a>
                    <a href="#" onclick="clearChat()"><i data-feather="trash-2"></i> Clear Chat</a>
                </div>
            </div>
        </div>

        <!-- Messages Container -->
        <div class="chat-messages-container" id="chatMessages">
            {% for message in messages %}
            <div class="message-wrapper {% if message.sender == request.user %}sent{% else %}received{% endif %}" data-message-id="{{ message.id }}">
                {% if message.sender != request.user %}
                <img src="{{ message.sender.get_avatar_url }}" alt="" class="message-avatar">
                {% endif %}
                <div class="message-bubble">
                    <p class="message-text">{{ message.content }}</p>
                    <div class="message-meta">
                        <span class="message-time">{{ message.created_at|time:"H:i" }}</span>
                        {% if message.sender == request.user %}
                        {% if message.is_read %}
                        <i data-feather="check-circle" class="read-icon" title="Read"></i>
                        {% else %}
                        <i data-feather="check" class="sent-icon" title="Sent"></i>
                        {% endif %}
                        {% endif %}
                    </div>
                    {% if message.sender == request.user %}
                    <div class="message-actions">
                        <button onclick="editMessage({{ message.id }}, '{{ message.content|escapejs }}')" title="Edit">
                            <i data-feather="edit-2"></i>
                        </button>
                        <button onclick="deleteMessage({{ message.id }})" title="Delete">
                            <i data-feather="trash-2"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="chat-empty-state">
                <div class="empty-icon">
                    <i data-feather="message-circle"></i>
                </div>
                <h4>Start the conversation</h4>
                <p>Send a message to {{ other_user.first_name }} to begin chatting</p>
            </div>
            {% endfor %}
        </div>

        <!-- Message Input -->
        <div class="chat-input-container">
            <form method="post" action="{% url 'chat:send' conversation.id %}" class="chat-input-form" id="chatForm">
                {% csrf_token %}
                <button type="button" class="btn btn-ghost btn-icon" title="Add Emoji">
                    <i data-feather="smile"></i>
                </button>
                <input type="text" name="content" class="chat-input-field" placeholder="Type a message..." required autocomplete="off" id="messageInput">
                <button type="submit" class="btn btn-primary btn-icon" title="Send">
                    <i data-feather="send"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Edit Message Modal -->
<div class="modal-overlay" id="editMessageModal">
    <div class="modal-container modal-sm">
        <div class="modal-header">
            <h3>Edit Message</h3>
            <button class="modal-close" onclick="closeEditModal()">
                <i data-feather="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="editMessageForm">
                <input type="hidden" id="editMessageId">
                <textarea id="editMessageContent" class="form-input" rows="3"></textarea>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Mobile Toggle Button -->
<button class="sidebar-toggle-mobile">
    <i data-feather="menu"></i>
</button>
<div class="sidebar-overlay"></div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
/* Chat Page Layout */
.chat-page-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    height: calc(100vh - 130px);
    gap: 0;
    background: var(--surface-color);
    border-radius: var(--card-radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
}

/* Conversations Sidebar */
.chat-conversations-sidebar {
    background: var(--surface-color);
    border-right: 1px solid var(--border-color, #e5e7eb);
    display: flex;
    flex-direction: column;
}

.sidebar-header-chat {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color, #e5e7eb);
}

.sidebar-header-chat h3 {
    margin: 0;
    font-size: 1rem;
}

.conversation-list-mini {
    flex: 1;
    overflow-y: auto;
}

.conv-mini-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    text-decoration: none;
    color: inherit;
    border-bottom: 1px solid var(--border-color, #e5e7eb);
    transition: background 0.2s;
}

.conv-mini-item:hover {
    background: var(--background-color);
}

.conv-mini-item.active {
    background: var(--primary-light);
    border-left: 3px solid var(--primary-color);
}

.conv-mini-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
}

.conv-mini-name {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--text-primary);
}

.conv-mini-preview {
    font-size: 0.75rem;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.unread-dot {
    width: 8px;
    height: 8px;
    background: var(--primary-color);
    border-radius: 50%;
    flex-shrink: 0;
}

/* Main Chat Area */
.chat-main-area {
    display: flex;
    flex-direction: column;
    background: var(--background-color);
}

/* Chat Header */
.chat-header-main {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    background: var(--surface-color);
    border-bottom: 1px solid var(--border-color, #e5e7eb);
}

.mobile-back {
    display: none;
}

.chat-header-info {
    flex: 1;
}

.chat-header-name {
    margin: 0;
    font-size: 1rem;
}

.chat-header-role {
    font-size: 0.8125rem;
    color: var(--text-muted);
}

.chat-header-actions {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    position: relative;
}

.chat-dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: var(--surface-color);
    border-radius: var(--button-radius);
    box-shadow: var(--shadow-lg);
    min-width: 180px;
    display: none;
    z-index: 100;
}

.chat-dropdown-menu.active {
    display: block;
}

.chat-dropdown-menu a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: var(--text-secondary);
    text-decoration: none;
    transition: background 0.2s;
}

.chat-dropdown-menu a:hover {
    background: var(--background-color);
    color: var(--text-primary);
}

.chat-dropdown-menu i {
    width: 16px;
    height: 16px;
}

/* Messages Container */
.chat-messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

/* Message Wrapper */
.message-wrapper {
    display: flex;
    gap: 0.5rem;
    max-width: 75%;
}

.message-wrapper.sent {
    margin-left: auto;
    flex-direction: row-reverse;
}

.message-wrapper.received {
    margin-right: auto;
}

.message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    flex-shrink: 0;
    align-self: flex-end;
}

/* Message Bubble */
.message-bubble {
    position: relative;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    max-width: 100%;
}

.message-wrapper.sent .message-bubble {
    background: var(--primary-color);
    color: white;
    border-bottom-right-radius: 0.25rem;
}

.message-wrapper.received .message-bubble {
    background: var(--surface-color);
    color: var(--text-primary);
    border-bottom-left-radius: 0.25rem;
    box-shadow: var(--shadow-sm);
}

.message-text {
    margin: 0;
    line-height: 1.5;
    word-wrap: break-word;
}

.message-meta {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    margin-top: 0.25rem;
}

.message-time {
    font-size: 0.6875rem;
    opacity: 0.7;
}

.message-wrapper.received .message-time {
    color: var(--text-muted);
}

.read-icon, .sent-icon {
    width: 12px;
    height: 12px;
    opacity: 0.7;
}

/* Message Actions */
.message-actions {
    position: absolute;
    top: 50%;
    right: 100%;
    transform: translateY(-50%);
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s;
    padding-right: 0.5rem;
}

.message-wrapper.sent:hover .message-actions {
    opacity: 1;
    visibility: visible;
}

.message-actions button {
    background: var(--surface-color);
    border: none;
    padding: 0.375rem;
    border-radius: 50%;
    cursor: pointer;
    color: var(--text-secondary);
    box-shadow: var(--shadow-sm);
    transition: all 0.2s;
}

.message-actions button:hover {
    color: var(--primary-color);
    background: var(--background-color);
}

.message-actions i {
    width: 14px;
    height: 14px;
}

/* Chat Empty State */
.chat-empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--text-muted);
}

.empty-icon {
    width: 80px;
    height: 80px;
    background: var(--surface-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
}

.empty-icon i {
    width: 40px;
    height: 40px;
}

.chat-empty-state h4 {
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

/* Chat Input */
.chat-input-container {
    padding: 1rem 1.5rem;
    background: var(--surface-color);
    border-top: 1px solid var(--border-color, #e5e7eb);
}

.chat-input-form {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--background-color);
    border-radius: 24px;
    padding: 0.25rem 0.5rem;
}

.chat-input-field {
    flex: 1;
    border: none;
    background: transparent;
    padding: 0.75rem;
    font-size: 0.9375rem;
    outline: none;
}

.chat-input-form .btn-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Modal */
.modal-sm {
    max-width: 400px;
}

.modal-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    margin-top: 1rem;
}

/* Responsive */
@media (max-width: 768px) {
    .chat-page-layout {
        grid-template-columns: 1fr;
    }

    .chat-conversations-sidebar {
        display: none;
    }

    .mobile-back {
        display: flex;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Auto-scroll to bottom
const chatMessages = document.getElementById('chatMessages');
chatMessages.scrollTop = chatMessages.scrollHeight;

// Toggle chat menu
function toggleChatMenu() {
    document.getElementById('chatDropdownMenu').classList.toggle('active');
}

// Close menu when clicking outside
document.addEventListener('click', function(e) {
    const menu = document.getElementById('chatDropdownMenu');
    const btn = e.target.closest('[onclick="toggleChatMenu()"]');
    if (!btn && !e.target.closest('.chat-dropdown-menu')) {
        menu.classList.remove('active');
    }
});

// Handle form submission with AJAX
document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const input = document.getElementById('messageInput');
    const content = input.value.trim();

    if (!content) return;

    const formData = new FormData(this);

    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add message to chat
            const messageHtml = `
                <div class="message-wrapper sent" data-message-id="${data.message_id}">
                    <div class="message-bubble">
                        <p class="message-text">${data.content}</p>
                        <div class="message-meta">
                            <span class="message-time">${data.created_at}</span>
                            <i data-feather="check" class="sent-icon"></i>
                        </div>
                        <div class="message-actions">
                            <button onclick="editMessage(${data.message_id}, '${data.content.replace(/'/g, "\\'")}')" title="Edit">
                                <i data-feather="edit-2"></i>
                            </button>
                            <button onclick="deleteMessage(${data.message_id})" title="Delete">
                                <i data-feather="trash-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Remove empty state if exists
            const emptyState = chatMessages.querySelector('.chat-empty-state');
            if (emptyState) emptyState.remove();

            chatMessages.insertAdjacentHTML('beforeend', messageHtml);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            input.value = '';

            if (typeof feather !== 'undefined') feather.replace();
        }
    });
});

// Edit message
function editMessage(messageId, content) {
    document.getElementById('editMessageId').value = messageId;
    document.getElementById('editMessageContent').value = content;
    document.getElementById('editMessageModal').classList.add('active');
}

function closeEditModal() {
    document.getElementById('editMessageModal').classList.remove('active');
}

document.getElementById('editMessageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const messageId = document.getElementById('editMessageId').value;
    const content = document.getElementById('editMessageContent').value.trim();

    if (!content) return;

    const formData = new FormData();
    formData.append('content', content);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch(`/chat/message/${messageId}/edit/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update message in DOM
            const messageEl = document.querySelector(`[data-message-id="${messageId}"] .message-text`);
            if (messageEl) {
                messageEl.textContent = data.content;
            }
            closeEditModal();
        } else {
            alert(data.error || 'Failed to edit message');
        }
    });
});

// Delete message
function deleteMessage(messageId) {
    if (!confirm('Are you sure you want to delete this message?')) return;

    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch(`/chat/message/${messageId}/delete/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove message from DOM
            const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageEl) {
                messageEl.remove();
            }
        }
    });
}

// Clear chat (placeholder)
function clearChat() {
    alert('Clear chat functionality coming soon');
}

// Initialize feather icons
if (typeof feather !== 'undefined') {
    feather.replace();
}

// Close modal on escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditModal();
    }
});

// Close modal on overlay click
document.getElementById('editMessageModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});
</script>
{% endblock %}
